---
date: 2024-01-24
title: TIL (24.01.24) Tiary ì„œë²„ ì´ì‚¬í•˜ëŠ” ë‚ 
authors:
  - ysheee
categories:
  - TIL
comments: true
---
<!-- more -->

ë‚´ Free tierëŠ” ì§„ì¦‰ ëë‚˜ë²„ë ¤ì„œ ë‚´ê°€ ë°°í¬í•œ Tiary ì„œë²„ëŠ” ëˆì´ ë‚˜ê°„ë‹¤.. ğŸ’¸

ê·¸ë˜ì„œ Free tierê°€ ë‚¨ì•„ ìˆëŠ” ë¯¼ì§€ ì–¸ë‹ˆì˜ EC2 ì„œë²„ë¡œ ì´ì‚¬í•˜ê²Œ ë˜ì—ˆë‹¤

## ì´ì‚¿ì§ ì‹¸ê¸°

ì¼ë‹¨ TiaryëŠ” ë¼ì´íŠ¸ì„¸ì¼ ì„œë²„ì— DB, EC2 ì„œë²„ì— ë‹¤ë¥¸ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ë°°í¬ ë˜ì–´ ìˆëŠ” ìƒíƒœë¼ 

DB+ì„œë¹„ìŠ¤ë¡œ í•©ì³ì„œ ìƒˆë¡œìš´ ì„œë²„ì— ë°°í¬í•´ì•¼í–ˆë‹¤

ì„œë¹„ìŠ¤ ë‚´ë¦¬ê¸° ì „ì— ì»¨í…Œì´ë„ˆë³„ ì‚¬ìš©ëŸ‰ í™•ì¸í•´ë´¤ëŠ”ë°, Free-tier ì„œë²„ê°€ ì›Œë‚™ ì‘ë‹¤ë³´ë‹ˆ ì´ê²Œ ì˜ ëŒì•„ê°ˆ ìˆ˜ ìˆì„ê¹Œ ì‹¶ì—ˆë‹¤..

``` bash
docker stats
```
![tiary-usage](images/tiary-usage-1.png)

### DB Volume 

Tiary DBëŠ” ì €ë²ˆ ë…¸ë…¸ê·¸ë˜ë¨¸ìŠ¤ DBì™€ ë‹¬ë¦¬ ë°”ì¸ë“œ ë§ˆìš´íŠ¸ê°€ ì•„ë‹Œ ë³¼ë¥¨ì„ ì‚¬ìš©í•œë‹¤

ê·¸ë˜ì„œ ë³¼ë¥¨ì„ ì˜®ê²¨ì•¼ í–ˆë‹¤

??? quote
    ì•„ë˜ë¥¼ ì°¸ê³ í•´ì„œ ì§„í–‰

    - [ì°¸ê³ ë¸”ë¡œê·¸ royleej9](https://royleej9.tistory.com/entry/Docker-volume-BackupRestore)
    - OpenAI ChatGPT

**volume ë°±ì—…**

``` bash 
# tiary_tiary-data ë³¼ë¥¨ì˜ ë‚´ìš©ì„ backup.tarë¡œ ì••ì¶•í•˜ì—¬ í˜„ì¬ í˜¸ìŠ¤íŠ¸ì˜ ì‘ì—… ë””ë ‰í† ë¦¬ì— ìƒì„±
docker run --rm -v tiary_tiary-data: /data -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /data
```

- ë°±ì—… ëŒ€ìƒ volumeì„ ì‚¬ìš©í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì¤‘ì§€
- ë°±ì—… ì‹¤í–‰ìš© ì„ì‹œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ì—¬ ë°±ì—…íŒŒì¼(tar)ì„ ìƒì„±í•œ í›„ í•´ë‹¹ ì»¨í…Œì´ë„ˆ ì‚­ì œ
- `docker run --rm` : ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘ í›„ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ë©´ ì»¨í…Œì´ë„ˆ ìë™ ì‚­ì œ
- `-v tiary_tiary-data: /data` : `tiary_tiary-data` ë³¼ë¥¨ì„ ì»¨í…Œì´ë„ˆì˜ `/data` ë””ë ‰í† ë¦¬ì— ë§ˆìš´íŠ¸ (í•´ë‹¹ ì»¨í…Œì´ë„ˆì—ì„œ ë³¼ë¥¨ ë°ì´í„°ì— ì ‘ê·¼)
- `-v $(pwd):/backup` : í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì»¨í…Œì´ë„ˆì˜ `/backup` ë””ë ‰í† ë¦¬ì— ë§ˆìš´íŠ¸ (= ë°±ì—… íŒŒì¼ì„ í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì— ì €ì¥í•˜ê¸° ìœ„í•¨)
- `ubuntu` : ubuntu ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ì»¨í…Œì´ë„ˆ ìƒì„±
- `tar cvf /backup/backup.tar /data` : tar ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ `/data` ë””ë ‰í† ë¦¬ì˜ ë‚´ìš©ì„ `/backup/backup.tar` íŒŒì¼ë¡œ ì••ì¶•
    - `c` : ìƒˆë¡œìš´ ì•„ì¹´ì´ë¸Œ ìƒì„±
    - `v` : ì²˜ë¦¬ë˜ëŠ” íŒŒì¼ í‘œì‹œ (ìƒì„¸ ëª¨ë“œ)
    - `f` : ì•„ì¹´ì´ë¸Œ íŒŒì¼ëª… ì§€ì •

ì´í›„ scpë¥¼ ì´ìš©í•´ ë¡œì»¬ë¡œ íŒŒì¼ì„ ì „ì†¡ë°›ì•˜ë‹¤
``` bash title="Local"
scp -i ~/.ssh/tiary-awslight.pem ubuntu@0.0.0.0:/home/ubuntu/tiary/backup.tar ./
```

### prometheus.yml

``` yaml
global:
  scrape_interval: 5s

scrape_configs:
  - job_name: "multiple_services"
    metrics_path: "/actuator/prometheus"
    static_configs:
      - targets: [ "tiary-server:8088", "tiary-batch:8089", "tiary-payment:8889" ]
```


## ì´ì‚¿ë‚ 

AWS ê³„ì •ì£¼ ë¯¼ì§€ ì–¸ë‹ˆ + ë‚˜ + ë‹¤ë¥¸ ì–¸ë‹ˆë“¤ê¹Œì§€ í•´ì„œ ë””ìŠ¤ì½”ë“œ í™”ìƒ íšŒì˜ë¡œ ì§„í–‰í–ˆë‹¤

ì ê¹ ë¼ì´ë¸Œ í•´ë´¤ëŠ”ë° ì•½ê°„ ìŠ¤íŠ¸ë¦¬ë¨¸ ëœ ê²ƒ ê°™ê³  ì‹ ê¸°í•¨..

ë¯¼ì§€ ì–¸ë‹ˆê°€ ë¼ì´ë¸Œë¥¼ í‚¤ê³ , ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ë³´ë©´ì„œ ì±„íŒ…ìœ¼ë¡œ ë°©í–¥ ì¡ì•„ì£¼ëŠ” ëŠë‚Œìœ¼ë¡œ ì§„í–‰í–ˆë‹¤

![discord-char-1](images/discord-chat-1.png){: style="height:60%;width:60%"}

1. AWS EC2 ì ‘ì†

2. [Install Docker](https://ysheee.github.io/docker/note/installation/)

3. Create DB volume 

    ``` bash
    ## tiary_20240124.tar : volumeì„ ì••ì¶•í•œ íŒŒì¼

    ## mkdir db_backup

    ## cd db_backup # í•´ë‹¹ ë””ë ‰í„°ë¦¬ ì•ˆì— tiary_20240124.tar íŒŒì¼ ë„£ì–´ë‘ê¸°

    docker volume create tiary-db-volume # ë³¼ë¥¨ ìƒì„±

    docker run --rm -v tiary-db-volume:/var/lib/mysql -v $(pwd):/backup ubuntu sh -c "cd /var/lib/mysql && tar xvf /backup/tiary_20240124.tar --strip 1"

    docker volume ls
    ```

    - `-v tiary-db-volume:/var/lib/mysql` : tiary-db-volumeì´ë¼ëŠ” ë„ì»¤ ë³¼ë¥¨ì„ ì»¨í…Œì´ë„ˆì˜ /var/lib/mysql ë””ë ‰í„°ë¦¬ì— ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤. MySQLì´ ì´ ê²½ë¡œë¥¼ ë°ì´í„° ì €ì¥ì†Œë¡œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ì„œ ì»¨í…Œì´ë„ˆ ë‚´ì˜ MySQL ë°ì´í„°ë¥¼ ë³¼ë¥¨ì— ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - `-v $(pwd):/backup` : í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ì»¨í…Œì´ë„ˆì˜ /backup ë””ë ‰í„°ë¦¬ì— ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤. (ë¡œì»¬ ì‹œìŠ¤í…œì—ì„œ ë°±ì—… íŒŒì¼ì„ ì»¨í…Œì´ë„ˆë¡œ ì „ì†¡)
    - `ubuntu` : ubuntu ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ìƒì„±
    - `sh -c "cd /var/lib/mysql && tar xvf /backup/tiary_20240124.tar --strip 1` : ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰ë  ëª…ë ¹ì–´ 
    <br>
     (`var/lib/mysql` ë””ë ‰í„°ë¦¬ë¡œ ì´ë™í•œ í›„, `/backup` ë””ë ‰í„°ë¦¬ì— ìˆëŠ” tiary_20240124.tar íŒŒì¼ì„ í˜„ì¬ ë””ë ‰í„°ë¦¬ `/var/lib/mysql`ë¡œ ì••ì¶• í•´ì œí•˜ë©° `--strip 1` ì˜µì…˜ìœ¼ë¡œ ì¸í•´ ì••ì¶• í•´ì œ ê³¼ì •ì—ì„œ ìµœìƒìœ„ ë””ë ‰í„°ë¦¬ë¥¼ ì œê±°í•˜ê³  íŒŒì¼ë“¤ì„ í˜„ì¬ ê²½ë¡œì— ì§ì ‘ ì¶”ì¶œí•¨) 

4. monitoring dir structure

    ``` bash
    monitoring/
    	 grafana/
    		 data/
    	 prometheus/
    		 prometheus.yml
    ```

5. [swap-memory](https://sundries-in-myidea.tistory.com/102)

6. docker-compose.yml ì¤€ë¹„

    ``` yaml
    version: '3'
    services:
      client:
        container_name: tiary-vuejs
        image: dockerhub_name/tiary:client
        ports:
          - "5173:80"
        restart: always

      mysql:
        container_name: tiary-mysql
        image: mysql:8.0
        ports:
          - "3306:3306"
        restart: always
        volumes:
          - tiary-db-volume:/var/lib/mysql

      eureka:
        container_name: tiary-eureka
        image: dockerhub_name/tiary:eureka
        ports:
          - "8761:8761"
        depends_on:
          - mysql
        restart: always

      config:
        container_name: tiary-config
        image: dockerhub_name/tiary:config
        ports:
          - "9000:9000"
        depends_on:
          - eureka
        restart: unless-stopped

      server:
        container_name: tiary-server
        image: dockerhub_name/tiary:server
        environment:
          - TZ=Asia/Seoul
        ports:
          - "8088:8088"
        depends_on:
          - eureka
          - config
        restart: unless-stopped

      batch:
        container_name: tiary-batch
        image: dockerhub_name/tiary:batch
        environment:
          - TZ=Asia/Seoul
        ports:
          - "8089:8089"
        depends_on:
          - eureka
          - config
          - server
        restart: unless-stopped

      payment:
        container_name: tiary-payment
        image: dockerhub_name/tiary:payment
        environment:
          - TZ=Asia/Seoul
        ports:
          - "8889:8889"
        depends_on:
          - eureka
          - config
        restart: unless-stopped

      gateway:
        container_name: tiary-gateway
        image: dockerhub_name/tiary:gateway
        ports:
          - "8090:8090"
        depends_on:
          - eureka

      redis:
        container_name: tiary-redis
        image: redis
        ports:
          - "6379:6379"
        restart: unless-stopped

      prometheus:
        container_name: tiary-prometheus
        image: prom/prometheus
        ports:
          - "9090:9090"
        volumes:
          - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

      grafana:
        container_name: tiary-grafana
        image: grafana/grafana
        ports:
          - "3000:3000"
        depends_on:
          - prometheus
        volumes:
          - ./monitoring/grafana/data:/var/lib/grafana

    volumes:
      tiary-db-volume:
        external: true
    ```

7. docker compose up

``` bash
docker-compose up -d && \
    docker-compose logs -f --tail 100
```


---
:construction: :fontawesome-solid-triangle-exclamation:

ë‹¤ìŒë²ˆì—ëŠ” ë§ˆëƒ¥ ë°°í¬í•˜ì§€ ë§ê³ , íš¨ìœ¨ì„ ìœ„í•´ CPU limitë„ ì•Œì•„ë³´ê³  ê±¸ì–´ë´ì•¼ì§€

- [Docker Compose resources](https://docs.docker.com/compose/compose-file/compose-file-v3/#resources)
- [Docker Command config](https://docs.docker.com/config/containers/resource_constraints/)

ì´ë ‡ê²Œ í…ŒìŠ¤íŠ¸ ì„œë²„ ì´ì‚¬í•˜ë“¯ì´ ë§ê³ , ë¼ì´ë¸Œ ì„œë¹„ìŠ¤ ì´ì‚¬í•˜ëŠ” ê±°ë¼ ìƒê°í•˜ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ :face_with_monocle:

monitoringë„ ë³¼ë¥¨ìœ¼ë¡œ ë‘ì–´ì•¼ê² ë‹¤

---